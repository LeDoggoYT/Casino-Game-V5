<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="favicon.png"/>
  <title>Mein Konto</title>
  <style>
    :root{
      --bg:#07140f;
      --felt:#0c3b2e;
      --felt2:#0b2f25;
      --gold:#d8b15a;
      --gold2:#a77c2a;
      --text:#eaf3ef;
      --muted:#a9c1b9;
      --danger:#ff5d5d;
      --ok:#5dffb1;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --card:#f7f7f7;
      --card2:#ececec;
      --ink:#111;
      --chipRed:#d64545;
      --chipBlue:#3f74ff;
      --chipGreen:#42c07a;
      --chipBlack:#2b2b2b;
      --chipWhite:#e9e9e9;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 70% 0%, rgba(216,177,90,.12), transparent 60%),
        radial-gradient(900px 700px at 10% 10%, rgba(63,116,255,.10), transparent 55%),
        radial-gradient(1100px 900px at 50% 110%, rgba(93,255,177,.08), transparent 60%),
        linear-gradient(180deg, #04110d, #030b08 55%, #020705);
      overflow-x:hidden;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; padding:14px}
    }

    .topbar{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-radius: var(--radius);
      background: rgba(10,24,18,.55);
      border:1px solid rgba(216,177,90,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 220px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(145deg, rgba(216,177,90,.85), rgba(167,124,42,.65));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.22), 0 12px 24px rgba(0,0,0,.25);
      position:relative;
    }
    .logo:after{
      content:"â™ ";
      position:absolute; inset:0;
      display:grid; place-items:center;
      color:#1a1408;
      font-size:22px;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
      opacity:.9;
    }
    .brand h1{
      font-size:14px; letter-spacing:.18em; margin:0;
      text-transform:uppercase;
      color: rgba(234,243,239,.92);
    }
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .top-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .pill strong{font-size:13px}
    .pill span{font-size:12px; color:var(--muted)}
    .btn{
      border:0; cursor:pointer;
      padding:11px 14px;
      border-radius: 12px;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      background: linear-gradient(145deg, rgba(216,177,90,.9), rgba(167,124,42,.75));
      border-color: rgba(216,177,90,.35);
      color:#1b1409;
      font-weight:700;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .btn.primary:hover{border-color: rgba(216,177,90,.55)}
    .btn.danger{
      background: rgba(255,93,93,.12);
      border-color: rgba(255,93,93,.25);
      color: rgba(255,220,220,.98);
    }
    .btn.small{padding:9px 11px; border-radius: 10px; font-size:13px}
    .btn:disabled{
      opacity:.45; cursor:not-allowed;
      transform:none !important;
    }

    .table{
      background:
        radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(700px 500px at 20% 70%, rgba(216,177,90,.10), transparent 60%),
        radial-gradient(700px 500px at 85% 70%, rgba(63,116,255,.10), transparent 60%),
        linear-gradient(180deg, var(--felt), var(--felt2));
      border-radius: 28px;
      border:1px solid rgba(216,177,90,.22);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      min-height: 620px;
    }

    .table:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 30px;
      border:1px solid rgba(255,255,255,.06);
      pointer-events:none;
    }

    .arc{
      position:absolute;
      left:50%; top:45px;
      width: 780px; height: 380px;
      transform: translateX(-50%);
      border-radius: 0 0 780px 780px;
      border: 2px solid rgba(216,177,90,.18);
      filter: blur(.0px);
      opacity:.8;
    }
    .arc:after{
      content:"BLACKJACK PAYS 3 TO 2 Â· DEALER STANDS ON 17";
      position:absolute;
      left:50%; top: 18px;
      transform: translateX(-50%);
      font-size:12px;
      letter-spacing:.18em;
      color: rgba(216,177,90,.75);
      text-transform:uppercase;
      white-space:nowrap;
    }

    .zone{
      position:relative;
      padding:18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .handRow{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .seat{
      flex: 1 1 320px;
      padding:14px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
    }

    .seatHeader{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .seatHeader .who{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(216,177,90,.14);
      border:1px solid rgba(216,177,90,.22);
      color: rgba(216,177,90,.92);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .score{
      font-size:12px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
    }
    .score b{color: var(--text); font-size:14px}

    .cards{
      display:flex; gap:10px; align-items:center;
      min-height: 128px;
      padding:8px 4px;
      flex-wrap:wrap;
    }

    .card{
      width:86px; height:120px;
      border-radius: 14px;
      background: linear-gradient(180deg, var(--card), var(--card2));
      color: var(--ink);
      position:relative;
      box-shadow: 0 18px 30px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.12);
      transform: translateY(0) rotate(0deg);
      opacity:0;
      animation: deal .26s ease forwards;
    }
    @keyframes deal{
      from{opacity:0; transform: translateY(-18px) rotate(-2deg) scale(.98)}
      to{opacity:1; transform: translateY(0) rotate(0deg) scale(1)}
    }
    .card .corner{
      position:absolute;
      left:10px; top:10px;
      font-weight:800;
      font-size:15px;
      line-height:1.05;
    }
    .card .corner.bottom{
      left:auto; top:auto; right:10px; bottom:10px;
      transform: rotate(180deg);
    }
    .card .suit{
      position:absolute;
      inset:0;
      display:grid; place-items:center;
      font-size:34px;
      opacity:.9;
    }
    .card.red{color:#b3112e}
    .card.black{color:#111}

    .card.back{
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(145deg, rgba(63,116,255,.85), rgba(31,47,96,.88));
      border:1px solid rgba(0,0,0,.22);
      color: rgba(255,255,255,.0);
      overflow:hidden;
    }
    .card.back:before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.20);
      opacity:.9;
    }
    .card.back:after{
      content:"";
      position:absolute; inset:-40px;
      background:
        repeating-linear-gradient(45deg, rgba(255,255,255,.08), rgba(255,255,255,.08) 8px, transparent 8px, transparent 16px);
      transform: rotate(10deg);
      opacity:.45;
    }

    .betbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.22);
      position:sticky;
      bottom:0;
    }

    .chips{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .chips .btn.small{
      height:44px;
      padding:8px 14px;
      border-radius:999px;
      font-weight:600;
      letter-spacing:.02em;
      background: rgba(8,16,12,.4);
      border-color: rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    .chips .btn.small:hover{
      background: rgba(12,22,16,.55);
      border-color: rgba(255,255,255,.22);
    }
    .chip{
      width:56px; height:56px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
      display:grid; place-items:center;
      font-weight:900;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .chip:hover{transform: translateY(-2px) scale(1.02); filter: brightness(1.03)}
    .chip:active{transform: translateY(0px) scale(.99)}
    .chip:before{
      content:"";
      position:absolute; inset:8px;
      border-radius:999px;
      border:2px dashed rgba(255,255,255,.22);
      opacity:.85;
    }
    .chip small{
      position:absolute; bottom:-18px;
      font-size:11px; color: rgba(234,243,239,.65);
      font-weight:600;
      letter-spacing:.06em;
    }
    .chip.red{background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), transparent 55%), linear-gradient(145deg, rgba(214,69,69,.95), rgba(136,28,28,.88));}
    .chip.blue{background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), transparent 55%), linear-gradient(145deg, rgba(63,116,255,.95), rgba(17,36,88,.88));}
    .chip.green{background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), transparent 55%), linear-gradient(145deg, rgba(66,192,122,.95), rgba(12,84,46,.88));}
    .chip.black{background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.14), transparent 55%), linear-gradient(145deg, rgba(43,43,43,.98), rgba(6,6,6,.92));}
    .chip.white{background: radial-gradient(circle at 35% 30%, rgba(0,0,0,.08), transparent 55%), linear-gradient(145deg, rgba(233,233,233,.98), rgba(160,160,160,.88)); color:#111; border-color: rgba(0,0,0,.18);}
    .chip.white:before{border-color: rgba(0,0,0,.16)}

    .betbox{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
    }
    .bet{
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      min-width: 200px;
    }
    .bet .line{display:flex; justify-content:space-between; gap:10px; font-size:12px; color: var(--muted)}
    .bet .line b{color: var(--text); font-size:14px}

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }

    .panel{
      background: rgba(10,24,18,.55);
      border:1px solid rgba(216,177,90,.14);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panel .head{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .panel .head h2{
      margin:0;
      font-size:13px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(216,177,90,.86);
    }
    .panel .body{padding:14px 16px}

    .statgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      padding:12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.07);
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:900; margin-top:4px}
    .stat .v small{font-size:12px; color:var(--muted); font-weight:700}

    .leaderboard{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .leaderboard-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 220px;
      overflow:auto;
    }
    .leaderboard-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      font-size:12px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
    }
    .leaderboard-item:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12)}
    .leaderboard-item.active{border-color: rgba(216,177,90,.45)}
    .leaderboard-item .name{font-weight:700}
    .leaderboard-item .balance{color: var(--muted)}
    .leaderboard-details{
      padding:10px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.07);
      font-size:12px;
      color: rgba(234,243,239,.9);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .leaderboard-details .line{
      display:flex;
      justify-content:space-between;
      gap:12px;
      color: var(--muted);
    }
    .leaderboard-details .line b{color: var(--text)}

    .admin-panel .body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .admin-status{
      font-size:11px;
      color: var(--muted);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 8px;
      padding:3px 8px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .admin-toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .admin-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 380px;
      overflow:auto;
    }
    .admin-user{
      padding:12px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .admin-user-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .admin-user-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .admin-badge{
      font-size:11px;
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.15);
    }
    .admin-badge.ok{
      color: var(--ok);
      border-color: rgba(93,255,177,.35);
      background: rgba(93,255,177,.08);
    }
    .admin-badge.danger{
      color: var(--danger);
      border-color: rgba(255,93,93,.35);
      background: rgba(255,93,93,.08);
    }
    .admin-meta{
      font-size:12px;
      color: var(--muted);
    }
    .admin-actions-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .admin-actions-row label{
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .admin-actions-row input[type="number"]{
      width:120px;
      padding:8px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:12px;
    }
    .admin-actions-row input[type="checkbox"]{
      width:16px;
      height:16px;
    }
    .admin-action-buttons{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(30px);
      opacity:0;
      pointer-events:none;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(216,177,90,.22);
      color: rgba(234,243,239,.95);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      transition: transform .18s ease, opacity .18s ease;
      font-size:13px;
      display:flex; align-items:center; gap:10px;
      z-index:99;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0px);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(216,177,90,.9);
      box-shadow: 0 0 0 4px rgba(216,177,90,.16);
    }

    .resultBanner{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .resultBanner .left{display:flex; flex-direction:column; gap:2px}
    .resultBanner .title{font-weight:900; letter-spacing:.02em}
    .resultBanner .sub{font-size:12px; color: var(--muted)}
    .resultBanner.win{border-color: rgba(93,255,177,.25); background: rgba(93,255,177,.08)}
    .resultBanner.lose{border-color: rgba(255,93,93,.25); background: rgba(255,93,93,.08)}
    .resultBanner.push{border-color: rgba(216,177,90,.25); background: rgba(216,177,90,.08)}

    .kbd{
      font-size:11px;
      color: rgba(234,243,239,.8);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      padding:3px 7px;
      border-radius: 8px;
      letter-spacing:.06em;
      white-space:nowrap;
    }
    .muted{color: var(--muted)}

    .is-hidden{display:none !important}

    .auth-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(2,7,5,.82);
      backdrop-filter: blur(8px);
      z-index:120;
      padding:18px;
    }
    .auth-card{
      width:min(420px, 92vw);
      background: rgba(10,24,18,.9);
      border:1px solid rgba(216,177,90,.18);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .auth-card h2{
      margin:0;
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(216,177,90,.86);
    }
    .auth-field{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      color: var(--muted);
    }
    .auth-field input{
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:14px;
      outline:none;
    }
    .auth-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .auth-error{
      font-size:12px;
      color: rgba(255,93,93,.92);
      min-height:16px;
    }
  </style>
</head>
<body>
  <div class="auth-overlay" id="authOverlay" role="dialog" aria-modal="true" aria-label="Login">
    <div class="auth-card">
      <h2>Login</h2>
      <div class="auth-field">
        <label for="authUser">Nutzername</label>
        <input id="authUser" name="username" autocomplete="username" />
      </div>
      <div class="auth-field">
        <label for="authPass">Passwort</label>
        <input id="authPass" type="password" name="password" autocomplete="current-password" />
      </div>
      <div class="auth-error" id="authError" aria-live="polite"></div>
      <div class="auth-actions">
        <button class="btn primary" id="loginBtn">Anmelden</button>
        <button class="btn" id="registerBtn">Registrieren</button>
      </div>
    </div>
  </div>

  <div class="wrap is-hidden" id="appWrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Blackjack Table</h1>
          <p>Realistischer Flow Â· Chips Â· Dealer steht auf 17</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill">
          <div>
            <span>Bankroll</span><br/>
            <strong id="bankrollText">â€”</strong>
          </div>
        </div>
        <div class="pill">
          <div>
            <span>Bet</span><br/>
            <strong id="betText">â€”</strong>
          </div>
        </div>
        <button class="btn small" id="soundBtn" title="Sound an/aus (S)">ðŸ”Š Sound</button>
      </div>
    </div>

    <main class="table" aria-label="Blackjack Tisch">
      <div class="arc" aria-hidden="true"></div>

      <div class="zone">
        <div class="handRow">
          <section class="seat" aria-label="Dealer Hand">
            <div class="seatHeader">
              <div class="who">Dealer <span class="badge">house</span></div>
              <div class="score">Score: <b id="dealerScore">â€”</b> <span id="dealerHint" class="muted"></span></div>
            </div>
            <div class="cards" id="dealerCards"></div>
          </section>

          <section class="seat" aria-label="Player Hand">
            <div class="seatHeader">
              <div class="who">Du <span class="badge">player</span></div>
              <div class="score">Score: <b id="playerScore">â€”</b> <span id="playerHint" class="muted"></span></div>
            </div>
            <div class="cards" id="playerCards"></div>

            <div id="resultWrap"></div>
          </section>
        </div>
      </div>

      <div class="betbar">
        <div class="chips" aria-label="Chips">
          <div class="chip white" data-amt="1" title="+1 (1)">1<small>1</small></div>
          <div class="chip red" data-amt="5" title="+5 (2)">5<small>5</small></div>
          <div class="chip blue" data-amt="25" title="+25 (3)">25<small>25</small></div>
          <div class="chip green" data-amt="100" title="+100 (4)">100<small>100</small></div>
          <div class="chip black" data-amt="500" title="+500 (5)">500<small>500</small></div>
          <button class="btn small" id="clearBetBtn" title="Bet lÃ¶schen (C)">Clear</button>
          <button class="btn small" id="resetBankrollBtn" title="Kontostand auf 2'500 CHF setzen">Reset 2'500</button>
          <button class="btn small" id="allInBtn" title="Gesamtes Konto setzen">All-in</button>
        </div>

        <div class="betbox">
          <div class="bet">
            <div class="line"><span>Aktueller Einsatz</span><b id="betBox">0</b></div>
            <div class="line"><span>Shortcut</span><span class="kbd">Space</span> Deal Â· <span class="kbd">H</span> Hit Â· <span class="kbd">D</span> Double Â· <span class="kbd">X</span> Stand</span></div>
          </div>

          <div class="controls">
            <button class="btn primary" id="dealBtn" title="Neue Runde (Space)">Deal</button>
            <button class="btn" id="hitBtn" title="Hit (H)" disabled>Hit</button>
            <button class="btn" id="standBtn" title="Stand (X)" disabled>Stand</button>
            <button class="btn" id="doubleBtn" title="Double (D)" disabled>Double</button>
            <button class="btn danger" id="newShoeBtn" title="Neues Deck / Shoe">New Shoe</button>
          </div>
        </div>
      </div>
    </main>

    <aside class="panel" aria-label="Stats">
      <div class="head">
        <h2>Session</h2>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
          <span class="kbd" title="Tip: Du kannst auch mit Tastatur spielen">Keyboard Ready</span>
        </div>
      </div>
      <div class="body">
        <div class="statgrid">
          <div class="stat">
            <div class="k">Runden</div>
            <div class="v" id="statRounds">0</div>
          </div>
          <div class="stat">
            <div class="k">Win / Lose / Push</div>
            <div class="v"><span id="statWin">0</span><small> / </small><span id="statLose">0</span><small> / </small><span id="statPush">0</span></div>
          </div>
          <div class="stat">
            <div class="k">Winrate</div>
            <div class="v" id="statWinrate">0%</div>
          </div>
          <div class="stat">
            <div class="k">Best Streak</div>
            <div class="v"><span id="statStreak">0</span><small> W</small></div>
          </div>
          <div class="stat">
            <div class="k">Shoe (Decks)</div>
            <div class="v"><span id="statDecks">6</span><small> decks</small></div>
          </div>
          <div class="stat">
            <div class="k">Cards left</div>
            <div class="v"><span id="statLeft">â€”</span></div>
          </div>
        </div>

        <div class="leaderboard" id="leaderboard">
          <div class="leaderboard-list" id="leaderboardList"></div>
          <div class="leaderboard-details" id="leaderboardDetails">
            <div class="line"><span>Spieler</span><b>â€”</b></div>
            <div class="line"><span>Kontostand</span><b>â€”</b></div>
            <div class="line"><span>Runden</span><b>â€”</b></div>
            <div class="line"><span>Win / Lose / Push</span><b>â€”</b></div>
            <div class="line"><span>Winrate</span><b>â€”</b></div>
            <div class="line"><span>Best Streak</span><b>â€”</b></div>
          </div>
        </div>
      </div>
    </aside>

    <aside class="panel admin-panel" aria-label="Admin">
      <div class="head">
        <h2>Admin</h2>
        <span class="admin-status" id="adminStatus">Gesperrt</span>
      </div>
      <div class="body">
        <div id="adminGate">
          <p class="muted">Hier kannst du Nutzer sperren, den Kontostand Ã¤ndern und Daten zurÃ¼cksetzen.</p>
          <div class="auth-field">
            <label for="adminPass">Admin-Passwort</label>
            <input id="adminPass" type="password" autocomplete="off" />
          </div>
          <div class="auth-error" id="adminError" aria-live="polite"></div>
          <div class="admin-actions-row">
            <button class="btn primary small" id="adminLoginBtn">Admin Ã¶ffnen</button>
          </div>
        </div>

        <div id="adminContent" class="is-hidden">
          <div class="admin-toolbar">
            <button class="btn small" id="adminRefreshBtn">Aktualisieren</button>
            <button class="btn small danger" id="adminLockBtn">Admin sperren</button>
          </div>
          <div class="admin-list" id="adminUserList"></div>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"><span class="dot"></span><span id="toastText">â€”</span></div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (q) => document.querySelector(q);
  const dealerCardsEl = $("#dealerCards");
  const playerCardsEl = $("#playerCards");
  const dealerScoreEl = $("#dealerScore");
  const playerScoreEl = $("#playerScore");
  const dealerHintEl  = $("#dealerHint");
  const playerHintEl  = $("#playerHint");
  const resultWrapEl  = $("#resultWrap");

  const bankrollText = $("#bankrollText");
  const betText = $("#betText");
  const betBox = $("#betBox");

  const dealBtn = $("#dealBtn");
  const hitBtn = $("#hitBtn");
  const standBtn = $("#standBtn");
  const doubleBtn = $("#doubleBtn");
  const clearBetBtn = $("#clearBetBtn");
  const resetBankrollBtn = $("#resetBankrollBtn");
  const allInBtn = $("#allInBtn");
  const newShoeBtn = $("#newShoeBtn");
  const soundBtn = $("#soundBtn");
  const logEl = null;
  const toastEl = $("#toast");
  const toastText = $("#toastText");

  const statRounds = $("#statRounds");
  const statWin = $("#statWin");
  const statLose = $("#statLose");
  const statPush = $("#statPush");
  const statWinrate = $("#statWinrate");
  const statStreak = $("#statStreak");
  const statDecks = $("#statDecks");
  const statLeft = $("#statLeft");

  const appWrap = $("#appWrap");
  const authOverlay = $("#authOverlay");
  const authUserInput = $("#authUser");
  const authPassInput = $("#authPass");
  const authError = $("#authError");
  const loginBtn = $("#loginBtn");
  const registerBtn = $("#registerBtn");
  const leaderboardList = $("#leaderboardList");
  const leaderboardDetails = $("#leaderboardDetails");
  const adminPassInput = $("#adminPass");
  const adminLoginBtn = $("#adminLoginBtn");
  const adminRefreshBtn = $("#adminRefreshBtn");
  const adminLockBtn = $("#adminLockBtn");
  const adminStatus = $("#adminStatus");
  const adminGate = $("#adminGate");
  const adminContent = $("#adminContent");
  const adminError = $("#adminError");
  const adminUserList = $("#adminUserList");

  const SUITS = ["â™ ","â™¥","â™¦","â™£"];
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

  const fmt = (n) => n.toLocaleString("de-CH");
  const AUTH_STORAGE_KEY = "bj_auth_v1";
  let authCache = null;
  let adminPasswordCache = null;
  let adminAuthed = false;

  function toast(msg){
    toastText.textContent = msg;
    toastEl.classList.add("show");
    window.clearTimeout(toast._t);
    toast._t = window.setTimeout(()=>toastEl.classList.remove("show"), 1300);
  }

  function log(){
    // intentionally muted in UI
  }

  // ---------- Simple WebAudio SFX ----------
  let audioOn = true;
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  function beep(type="deal"){
    if(!audioOn) return;
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);

    const presets = {
      deal:   {f1: 420, f2: 260, dur: .06, vol:.05},
      chip:   {f1: 240, f2: 180, dur: .05, vol:.06},
      win:    {f1: 520, f2: 760, dur: .12, vol:.06},
      lose:   {f1: 180, f2: 120, dur: .14, vol:.06},
      push:   {f1: 320, f2: 320, dur: .10, vol:.05},
      click:  {f1: 520, f2: 520, dur: .05, vol:.04},
    }[type] || {f1: 400, f2: 300, dur:.08, vol:.05};

    o.type = "triangle";
    o.frequency.setValueAtTime(presets.f1, t);
    o.frequency.exponentialRampToValueAtTime(Math.max(60, presets.f2), t + presets.dur);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(presets.vol, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + presets.dur);

    o.start(t);
    o.stop(t + presets.dur + 0.02);
  }

  // ---------- Game State ----------
  const defaultState = {
    bankroll: 2500,
    bet: 0,
    decks: 6,
    stats: { rounds:0, win:0, lose:0, push:0, streak:0, bestStreak:0 },
    audioOn: true
  };
  let currentUser = null;
  let state = null;

  let shoe = [];
  let player = [];
  let dealer = [];
  let inRound = false;
  let dealerHoleHidden = true;
  let doubled = false;

  async function apiFetch(path, payload){
    const options = payload ? {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    } : {};
    const res = await fetch(path, options);
    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      const message = data && data.error ? data.error : "Serverfehler";
      console.error(`API Fehler ${res.status} bei ${path}:`, message);
      throw new Error(message);
    }
    return data;
  }

  function normalizeUsername(name){
    return name.trim();
  }

  function normalizeState(serverState){
    if(!serverState) return structuredClone(defaultState);
    return {
      ...structuredClone(defaultState),
      ...serverState,
      stats: { ...structuredClone(defaultState.stats), ...(serverState.stats||{}) }
    };
  }

  function saveAuth(username, password){
    authCache = { username, password };
    try{
      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authCache));
    }catch{
      // keep in-memory fallback
    }
  }

  function loadAuth(){
    if(authCache) return authCache;
    try{
      const raw = localStorage.getItem(AUTH_STORAGE_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(!parsed || !parsed.username || !parsed.password) return null;
      authCache = parsed;
      return authCache;
    }catch{
      return authCache;
    }
  }

  function renderLeaderboard(users){
    leaderboardList.innerHTML = "";
    if(!users.length){
      leaderboardList.innerHTML = "<div class=\"muted\">Keine Spieler gefunden.</div>";
      return;
    }
    users.forEach((user, idx) => {
      const item = document.createElement("div");
      item.className = "leaderboard-item" + (idx === 0 ? " active" : "");
      item.innerHTML = `
        <span class="name">${user.username}</span>
        <span class="balance">${fmt(user.balance)} CHF</span>
      `;
      item.addEventListener("click", () => {
        document.querySelectorAll(".leaderboard-item").forEach(el => el.classList.remove("active"));
        item.classList.add("active");
        renderLeaderboardDetails(user);
      });
      leaderboardList.appendChild(item);
    });
    renderLeaderboardDetails(users[0]);
  }

  function renderLeaderboardDetails(user){
    if(!user){
      leaderboardDetails.innerHTML = `
        <div class="line"><span>Spieler</span><b>â€”</b></div>
        <div class="line"><span>Kontostand</span><b>â€”</b></div>
        <div class="line"><span>Runden</span><b>â€”</b></div>
        <div class="line"><span>Win / Lose / Push</span><b>â€”</b></div>
        <div class="line"><span>Winrate</span><b>â€”</b></div>
        <div class="line"><span>Best Streak</span><b>â€”</b></div>
      `;
      return;
    }
    const stats = user.stats || { rounds:0, win:0, lose:0, push:0, bestStreak:0 };
    const played = stats.rounds || 0;
    const winrate = played ? Math.round((stats.win / played) * 100) : 0;
    leaderboardDetails.innerHTML = `
      <div class="line"><span>Spieler</span><b>${user.username}</b></div>
      <div class="line"><span>Kontostand</span><b>${fmt(user.balance)} CHF</b></div>
      <div class="line"><span>Runden</span><b>${stats.rounds}</b></div>
      <div class="line"><span>Win / Lose / Push</span><b>${stats.win} / ${stats.lose} / ${stats.push}</b></div>
      <div class="line"><span>Winrate</span><b>${winrate}%</b></div>
      <div class="line"><span>Best Streak</span><b>${stats.bestStreak} W</b></div>
    `;
  }

  function setAdminVisibility(isVisible){
    if(isVisible){
      adminGate.classList.add("is-hidden");
      adminContent.classList.remove("is-hidden");
      adminStatus.textContent = "Entsperrt";
    }else{
      adminGate.classList.remove("is-hidden");
      adminContent.classList.add("is-hidden");
      adminStatus.textContent = "Gesperrt";
    }
  }

  function renderAdminUsers(users){
    adminUserList.innerHTML = "";
    if(!users.length){
      adminUserList.innerHTML = "<div class=\"muted\">Keine Nutzer gefunden.</div>";
      return;
    }
    users.forEach((user) => {
      const card = document.createElement("div");
      card.className = "admin-user";
      card.dataset.username = user.username;

      const head = document.createElement("div");
      head.className = "admin-user-head";

      const title = document.createElement("div");
      title.className = "admin-user-title";
      const name = document.createElement("strong");
      name.textContent = user.username;
      const badge = document.createElement("span");
      badge.className = `admin-badge ${user.locked ? "danger" : "ok"}`;
      badge.textContent = user.locked ? "Gesperrt" : "Aktiv";
      title.append(name, badge);

      const balance = document.createElement("span");
      balance.className = "muted";
      balance.textContent = `${fmt(user.balance)} CHF`;
      head.append(title, balance);

      const stats = user.stats || {};
      const meta = document.createElement("div");
      meta.className = "admin-meta";
      meta.textContent = `Runden: ${stats.rounds || 0} Â· W/L/P: ${stats.win || 0}/${stats.lose || 0}/${stats.push || 0}`;

      const actions = document.createElement("div");
      actions.className = "admin-actions-row";
      const balanceLabel = document.createElement("label");
      balanceLabel.textContent = "Kontostand";
      const balanceInput = document.createElement("input");
      balanceInput.type = "number";
      balanceInput.min = "0";
      balanceInput.step = "1";
      balanceInput.value = user.balance;
      balanceInput.dataset.field = "balance";
      balanceLabel.appendChild(balanceInput);

      const lockLabel = document.createElement("label");
      const lockInput = document.createElement("input");
      lockInput.type = "checkbox";
      lockInput.checked = !!user.locked;
      lockInput.dataset.field = "locked";
      lockLabel.append(lockInput, document.createTextNode("Gesperrt"));

      const buttons = document.createElement("div");
      buttons.className = "admin-action-buttons";
      const saveBtn = document.createElement("button");
      saveBtn.className = "btn small primary";
      saveBtn.dataset.action = "save";
      saveBtn.textContent = "Speichern";
      const resetBtn = document.createElement("button");
      resetBtn.className = "btn small";
      resetBtn.dataset.action = "reset";
      resetBtn.textContent = "Reset";
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn small danger";
      deleteBtn.dataset.action = "delete";
      deleteBtn.textContent = "LÃ¶schen";
      buttons.append(saveBtn, resetBtn, deleteBtn);

      actions.append(balanceLabel, lockLabel, buttons);
      card.append(head, meta, actions);
      adminUserList.appendChild(card);
    });
  }

  async function fetchAdminUsers(){
    if(!adminAuthed || !adminPasswordCache) return;
    try{
      const data = await apiFetch("/api/admin/users", { password: adminPasswordCache });
      renderAdminUsers(data.users || []);
    }catch(err){
      adminError.textContent = err.message || "Admin-Daten konnten nicht geladen werden.";
    }
  }

  async function handleAdminLogin(){
    adminError.textContent = "";
    const password = adminPassInput.value || "";
    if(!password.trim()){
      adminError.textContent = "Bitte Admin-Passwort eingeben.";
      return;
    }
    try{
      await apiFetch("/api/admin/login", { password });
      adminPasswordCache = password;
      adminAuthed = true;
      setAdminVisibility(true);
      await fetchAdminUsers();
      adminPassInput.value = "";
      toast("Admin aktiviert");
    }catch(err){
      adminError.textContent = err.message || "Admin-Login fehlgeschlagen.";
    }
  }

  function handleAdminLogout(){
    adminAuthed = false;
    adminPasswordCache = null;
    setAdminVisibility(false);
    adminUserList.innerHTML = "";
    toast("Admin gesperrt");
  }

  async function fetchLeaderboard(){
    try{
      const data = await apiFetch("/api/leaderboard");
      renderLeaderboard(data.users || []);
    }catch{
      renderLeaderboard([]);
    }
  }

  function setAuthVisibility(isVisible){
    if(isVisible){
      authOverlay.classList.remove("is-hidden");
      authOverlay.removeAttribute("aria-hidden");
      authOverlay.style.pointerEvents = "auto";
      appWrap.classList.add("is-hidden");
      appWrap.setAttribute("aria-hidden", "true");
    }else{
      authOverlay.classList.add("is-hidden");
      authOverlay.setAttribute("aria-hidden", "true");
      authOverlay.style.pointerEvents = "none";
      appWrap.classList.remove("is-hidden");
      appWrap.removeAttribute("aria-hidden");
    }
  }

  async function handleAuth(action, options = {}){
    const { silent = false } = options;
    authError.textContent = "";
    const username = normalizeUsername(authUserInput.value || "");
    const password = authPassInput.value || "";
    if(!username){
      if(!silent) authError.textContent = "Bitte einen Nutzernamen eingeben.";
      return;
    }
    if(!password.trim()){
      if(!silent) authError.textContent = "Bitte ein Passwort eingeben.";
      return;
    }

    try{
      const data = await apiFetch(action === "register" ? "/api/register" : "/api/login", {
        username,
        password
      });
      currentUser = username;
      saveAuth(username, password);
      state = normalizeState(data.state);
      setAuthVisibility(false);
      audioOn = !!state.audioOn;
      buildShoe();
      render();
      await fetchLeaderboard();
      log("Tip: Setze Chips, dann Deal. Viel GlÃ¼ck âœ¨", "muted");
    }catch(err){
      if(!silent){
        authError.textContent = err.message || "Anmeldung fehlgeschlagen.";
      }else{
        setAuthVisibility(true);
      }
    }
  }
  function saveState(){
    if(!currentUser || !state) return;
    void apiFetch("/api/state", { username: currentUser, state });
    void fetchLeaderboard();
  }

  function buildShoe(){
    shoe = [];
    for(let d=0; d<state.decks; d++){
      for(const suit of SUITS){
        for(const rank of RANKS){
          shoe.push({rank, suit});
        }
      }
    }
    // shuffle (Fisher-Yates)
    for(let i=shoe.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [shoe[i], shoe[j]] = [shoe[j], shoe[i]];
    }
    statDecks.textContent = state.decks;
    statLeft.textContent = fmt(shoe.length);
    log("Neuer Shoe gemischt.", "muted");
    toast("New Shoe ready");
    saveState();
  }

  function needReshuffle(){
    // reshuffle at ~25% left
    return shoe.length < (state.decks*52)*0.25;
  }

  function draw(){
    if(shoe.length === 0) buildShoe();
    const c = shoe.pop();
    statLeft.textContent = fmt(shoe.length);
    return c;
  }

  function cardColor(suit){
    return (suit==="â™¥"||suit==="â™¦") ? "red" : "black";
  }

  function cardValue(rank){
    if(rank==="A") return 11;
    if(["K","Q","J"].includes(rank)) return 10;
    return parseInt(rank,10);
  }

  function handTotals(hand){
    // returns best total <=21 if possible + soft flag
    let total = 0;
    let aces = 0;
    for(const c of hand){
      total += cardValue(c.rank);
      if(c.rank==="A") aces++;
    }
    // reduce aces from 11 to 1 as needed
    let soft = false;
    while(total > 21 && aces > 0){
      total -= 10;
      aces--;
    }
    // soft if there exists an ace counted as 11
    // easiest: recompute whether any ace could be 11 without busting
    total = 0; aces = 0;
    for(const c of hand){
      total += cardValue(c.rank);
      if(c.rank==="A") aces++;
    }
    let t = total;
    while(t > 21 && aces > 0){ t -= 10; aces--; }
    // if after fixing bust, there is still at least one ace that stayed 11:
    // that happens when original had an ace and we didn't have to convert all of them.
    // Detect by checking if any ace remains in "aces" from original count after bust reduction.
    // We'll do it by counting conversions:
    let total2 = 0; let aceCount = 0;
    for(const c of hand){ total2 += cardValue(c.rank); if(c.rank==="A") aceCount++; }
    let conversions = 0; let t2 = total2; let a2 = aceCount;
    while(t2 > 21 && a2 > 0){ t2 -= 10; a2--; conversions++; }
    // If there was at least one ace and conversions < aceCount, then at least one ace is still 11 => soft
    soft = (aceCount > 0 && conversions < aceCount && t2 <= 21);
    return { total: t2, soft };
  }

  function isBlackjack(hand){
    if(hand.length !== 2) return false;
    const v = handTotals(hand).total;
    return v === 21;
  }

  function canDouble(){
    if(!inRound) return false;
    if(doubled) return false;
    if(player.length !== 2) return false;
    if(state.bankroll < state.bet) return false;
    const t = handTotals(player).total;
    return t >= 9 && t <= 11; // classic-ish feel
  }

  function render(){
    // bankroll/bet
    bankrollText.textContent = fmt(state.bankroll) + " CHF";
    betText.textContent = fmt(state.bet) + " CHF";
    betBox.textContent = fmt(state.bet);

    // scores
    const p = handTotals(player);
    const d = handTotals(dealer);

    playerScoreEl.textContent = player.length ? p.total : "â€”";
    playerHintEl.textContent = player.length ? (p.soft ? "soft" : "") : "";

    if(!dealer.length){
      dealerScoreEl.textContent = "â€”";
      dealerHintEl.textContent = "";
    }else{
      if(dealerHoleHidden && dealer.length >= 2){
        // show only upcard value
        const up = dealer[0];
        const v = handTotals([up]).total; // Ace shows 11
        dealerScoreEl.textContent = v;
        dealerHintEl.textContent = "upcard";
      }else{
        dealerScoreEl.textContent = d.total;
        dealerHintEl.textContent = d.soft ? "soft" : "";
      }
    }

    // cards
    dealerCardsEl.innerHTML = "";
    playerCardsEl.innerHTML = "";

    dealer.forEach((c, idx)=>{
      if(idx === 1 && dealerHoleHidden){
        dealerCardsEl.appendChild(makeCardBack());
      }else{
        dealerCardsEl.appendChild(makeCardFace(c));
      }
    });
    player.forEach(c => playerCardsEl.appendChild(makeCardFace(c)));

    // buttons
    hitBtn.disabled = !inRound;
    standBtn.disabled = !inRound;
    doubleBtn.disabled = !canDouble();
    dealBtn.disabled = inRound || state.bet <= 0;

    // chips: disabled while in round
    document.querySelectorAll(".chip").forEach(ch => {
      ch.style.pointerEvents = inRound ? "none" : "auto";
      ch.style.opacity = inRound ? ".55" : "1";
    });
    clearBetBtn.disabled = inRound;
    resetBankrollBtn.disabled = inRound;
    allInBtn.disabled = inRound || state.bankroll <= 0;

    // stats
    statRounds.textContent = state.stats.rounds;
    statWin.textContent = state.stats.win;
    statLose.textContent = state.stats.lose;
    statPush.textContent = state.stats.push;
    statStreak.textContent = state.stats.bestStreak;

    const played = state.stats.rounds || 0;
    const wr = played ? Math.round((state.stats.win / played) * 100) : 0;
    statWinrate.textContent = wr + "%";

    // sound button
    audioOn = !!state.audioOn;
    soundBtn.textContent = audioOn ? "ðŸ”Š Sound" : "ðŸ”‡ Sound";
  }

  function makeCardFace(c){
    const el = document.createElement("div");
    el.className = `card ${cardColor(c.suit)}`;
    el.innerHTML = `
      <div class="corner">${c.rank}<br>${c.suit}</div>
      <div class="suit">${c.suit}</div>
      <div class="corner bottom">${c.rank}<br>${c.suit}</div>
    `;
    return el;
  }
  function makeCardBack(){
    const el = document.createElement("div");
    el.className = "card back";
    return el;
  }

  function setResultBanner(kind, title, sub){
    resultWrapEl.innerHTML = "";
    const b = document.createElement("div");
    b.className = `resultBanner ${kind}`;
    b.innerHTML = `
      <div class="left">
        <div class="title">${title}</div>
        <div class="sub">${sub}</div>
      </div>
      <button class="btn small" id="nextBtn">Next round</button>
    `;
    resultWrapEl.appendChild(b);
    $("#nextBtn").onclick = () => {
      resultWrapEl.innerHTML = "";
      toast("Place your bet");
    };
  }

  function clearResult(){
    resultWrapEl.innerHTML = "";
  }

  // ---------- Round Logic ----------
  function startRound(){
    if(inRound) return;
    if(state.bet <= 0){ toast("Setze erst einen Einsatz"); return; }
    if(state.bet > state.bankroll){ toast("Nicht genug Bankroll"); return; }

    // reshuffle if needed
    if(needReshuffle()){
      log("Shoe fast leer â†’ neu gemischt.", "muted");
      buildShoe();
    }

    inRound = true;
    dealerHoleHidden = true;
    doubled = false;
    clearResult();

    // take bet
    state.bankroll -= state.bet;
    saveState();

    player = [draw(), draw()];
    dealer = [draw(), draw()];

    beep("deal"); beep("deal");
    log(`Deal. Einsatz: ${fmt(state.bet)} CHF`, "muted");

    render();

    // check for natural blackjacks
    const pBJ = isBlackjack(player);
    const dBJ = isBlackjack(dealer);

    if(pBJ || dBJ){
      dealerHoleHidden = false;
      render();
      endRound(resolveOutcome(true));
      return;
    }

    // auto-stand if player 21
    if(handTotals(player).total === 21){
      stand();
    }
  }

  function hit(){
    if(!inRound) return;
    player.push(draw());
    beep("deal");
    render();

    const p = handTotals(player).total;
    if(p > 21){
      // bust
      dealerHoleHidden = false;
      render();
      endRound("lose", "BUST", `Du bist bei ${p}. Einsatz verloren.`);
    }
  }

  function stand(){
    if(!inRound) return;
    dealerHoleHidden = false;
    render();
    dealerPlayThenResolve();
  }

  function doubleDown(){
    if(!canDouble()) return;
    // take additional bet equal to original
    state.bankroll -= state.bet;
    state.bet *= 2;
    doubled = true;
    saveState();

    beep("chip");
    log(`Double. Neuer Einsatz: ${fmt(state.bet)} CHF`, "muted");

    // one card only
    player.push(draw());
    beep("deal");
    render();

    const p = handTotals(player).total;
    if(p > 21){
      endRound("lose", "BUST", `Double bust bei ${p}.`);
      return;
    }
    // then dealer plays
    dealerHoleHidden = false;
    render();
    dealerPlayThenResolve();
  }

  function dealerPlayThenResolve(){
    const p = handTotals(player).total;
    // dealer stands on all 17 (including soft 17) as printed on table
    while(true){
      const d = handTotals(dealer);
      if(d.total < 17){
        dealer.push(draw());
        beep("deal");
        render();
        continue;
      }
      break;
    }
    const outcome = resolveOutcome(false);
    endRound(outcome.kind, outcome.title, outcome.sub);
  }

  function resolveOutcome(naturalCheck){
    const pT = handTotals(player).total;
    const dT = handTotals(dealer).total;

    // naturals
    const pBJ = isBlackjack(player);
    const dBJ = isBlackjack(dealer);
    if(pBJ || dBJ){
      if(pBJ && dBJ) return {kind:"push", title:"PUSH", sub:"Beide Blackjack. Einsatz zurÃ¼ck."};
      if(pBJ) return {kind:"win", title:"BLACKJACK!", sub:"3:2 Auszahlung."};
      return {kind:"lose", title:"DEALER BLACKJACK", sub:"House takes it."};
    }

    if(pT > 21) return {kind:"lose", title:"BUST", sub:`Du bist bei ${pT}.`};
    if(dT > 21) return {kind:"win", title:"DEALER BUST", sub:`Dealer ist bei ${dT}.`};

    if(pT > dT) return {kind:"win", title:"YOU WIN", sub:`${pT} gegen ${dT}.`};
    if(pT < dT) return {kind:"lose", title:"YOU LOSE", sub:`${pT} gegen ${dT}.`};
    return {kind:"push", title:"PUSH", sub:`${pT} gegen ${dT}.`};
  }

  function payout(kind){
    // Returns amount to add back to bankroll (including bet return)
    // bet has already been removed from bankroll at round start
    if(kind === "push") return state.bet; // return bet
    if(kind === "win"){
      // blackjack pays 3:2 only if natural
      if(isBlackjack(player) && !isBlackjack(dealer)){
        // win profit 1.5x plus original bet returned => total 2.5x bet
        return Math.floor(state.bet * 2.5);
      }
      // normal win => 2x bet (return + profit)
      return state.bet * 2;
    }
    // lose => nothing returned
    return 0;
  }

  function endRound(kind, title, sub){
    // kind: win/lose/push OR object
    if(typeof kind === "object"){
      const o = kind;
      kind = o.kind; title = o.title; sub = o.sub;
    }
    inRound = false;
    dealerHoleHidden = false;

    // stats
    state.stats.rounds++;
    if(kind === "win"){
      state.stats.win++;
      state.stats.streak++;
      if(state.stats.streak > state.stats.bestStreak) state.stats.bestStreak = state.stats.streak;
      beep("win");
    }else if(kind === "lose"){
      state.stats.lose++;
      state.stats.streak = 0;
      beep("lose");
    }else{
      state.stats.push++;
      // keep streak as-is or reset? keep feels nicer:
      // state.stats.streak = state.stats.streak;
      beep("push");
    }

    // payout
    const back = payout(kind);
    state.bankroll += back;

    // log
    if(kind === "win"){
      log(`WIN â†’ +${fmt(back)} CHF`, "good");
      toast("Win");
      setResultBanner("win", title, sub + ` Â· Ausgezahlt: ${fmt(back)} CHF`);
    }else if(kind === "lose"){
      log(`LOSE â†’ +0 CHF`, "bad");
      toast("Lose");
      setResultBanner("lose", title, sub);
    }else{
      log(`PUSH â†’ +${fmt(back)} CHF`, "muted");
      toast("Push");
      setResultBanner("push", title, sub + ` Â· Einsatz zurÃ¼ck: ${fmt(back)} CHF`);
    }

    // reset bet to something comfy if player is broke
    if(state.bankroll <= 0){
      state.bankroll = 2500;
      state.bet = 0;
      log("Bankroll war leer â†’ auf 2'500 CHF zurÃ¼ckgesetzt.", "muted");
      toast("Bankroll reset");
    }

    // bet goes back to previous base (if doubled, shrink it back to half)
    if(doubled) state.bet = Math.floor(state.bet / 2);

    saveState();
    render();
  }

  // ---------- Betting ----------
  function addBet(amt){
    if(!state) return;
    if(inRound) return;
    if(amt <= 0) return;
    if(state.bet + amt > state.bankroll){
      toast("Zu hoher Einsatz");
      return;
    }
    state.bet += amt;
    saveState();
    beep("chip");
    render();
  }
  function clearBet(){
    if(!state) return;
    if(inRound) return;
    state.bet = 0;
    saveState();
    beep("click");
    render();
  }

  function resetBankroll(){
    if(!state) return;
    if(inRound) return;
    state.bankroll = 2500;
    state.bet = 0;
    saveState();
    log("Bankroll manuell auf 2'500 CHF gesetzt.", "muted");
    toast("Kontostand zurÃ¼ckgesetzt");
    beep("click");
    render();
  }

  function allIn(){
    if(!state) return;
    if(inRound) return;
    if(state.bankroll <= 0){
      toast("Kein Guthaben fÃ¼r All-in");
      return;
    }
    state.bet = state.bankroll;
    saveState();
    beep("chip");
    toast("All-in gesetzt");
    render();
  }

  // ---------- Events ----------
  loginBtn.addEventListener("click", () => handleAuth("login"));
  registerBtn.addEventListener("click", () => handleAuth("register"));
  authPassInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") handleAuth("login");
  });
  adminLoginBtn.addEventListener("click", handleAdminLogin);
  adminPassInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") handleAdminLogin();
  });
  adminRefreshBtn.addEventListener("click", fetchAdminUsers);
  adminLockBtn.addEventListener("click", handleAdminLogout);
  adminUserList.addEventListener("click", async (event) => {
    if(!adminAuthed || !adminPasswordCache) return;
    const button = event.target.closest("button[data-action]");
    if(!button) return;
    const card = button.closest(".admin-user");
    if(!card) return;
    const username = card.dataset.username;
    if(!username) return;
    const action = button.dataset.action;
    const balanceInput = card.querySelector("input[data-field=\"balance\"]");
    const lockInput = card.querySelector("input[data-field=\"locked\"]");
    try{
      if(action === "save"){
        const balanceValue = Number(balanceInput?.value);
        if(!Number.isFinite(balanceValue) || balanceValue < 0){
          toast("Bitte gÃ¼ltigen Kontostand eingeben");
          return;
        }
        await apiFetch("/api/admin/user/update", {
          password: adminPasswordCache,
          username,
          updates: {
            balance: balanceValue,
            locked: !!lockInput?.checked
          }
        });
        toast("User gespeichert");
        await fetchAdminUsers();
        await fetchLeaderboard();
      }
      if(action === "reset"){
        if(!confirm(`Daten von ${username} zurÃ¼cksetzen?`)) return;
        await apiFetch("/api/admin/user/reset", {
          password: adminPasswordCache,
          username
        });
        toast("User zurÃ¼ckgesetzt");
        await fetchAdminUsers();
        await fetchLeaderboard();
      }
      if(action === "delete"){
        if(!confirm(`User ${username} wirklich lÃ¶schen?`)) return;
        await apiFetch("/api/admin/user/delete", {
          password: adminPasswordCache,
          username
        });
        toast("User gelÃ¶scht");
        await fetchAdminUsers();
        await fetchLeaderboard();
      }
    }catch(err){
      adminError.textContent = err.message || "Admin-Ã„nderung fehlgeschlagen.";
    }
  });
  document.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => addBet(parseInt(ch.dataset.amt,10)));
  });

  dealBtn.addEventListener("click", startRound);
  hitBtn.addEventListener("click", hit);
  standBtn.addEventListener("click", stand);
  doubleBtn.addEventListener("click", doubleDown);
  clearBetBtn.addEventListener("click", clearBet);
  resetBankrollBtn.addEventListener("click", resetBankroll);
  allInBtn.addEventListener("click", allIn);

  newShoeBtn.addEventListener("click", () => {
    if(inRound){
      toast("Warte bis die Runde fertig ist");
      return;
    }
    buildShoe();
    render();
  });

  soundBtn.addEventListener("click", () => {
    state.audioOn = !state.audioOn;
    saveState();
    render();
    toast(state.audioOn ? "Sound an" : "Sound aus");
    beep("click");
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    if(!state) return;
    const k = e.key.toLowerCase();
    if(k === " "){
      e.preventDefault();
      if(!inRound) startRound();
      return;
    }
    if(k === "h") hit();
    if(k === "x") stand();
    if(k === "d") doubleDown();
    if(k === "c") clearBet();
    if(k === "s"){
      state.audioOn = !state.audioOn;
      saveState();
      render();
      toast(state.audioOn ? "Sound an" : "Sound aus");
      beep("click");
    }
    if(k === "1") addBet(1);
    if(k === "2") addBet(5);
    if(k === "3") addBet(25);
    if(k === "4") addBet(100);
    if(k === "5") addBet(500);
  });

  // ---------- Init ----------
  (async () => {
    setAuthVisibility(true);
    setAdminVisibility(false);
    const saved = loadAuth();
    if(saved){
      authUserInput.value = saved.username;
      authPassInput.value = saved.password;
      await handleAuth("login", { silent: true });
    }
  })();
})();
</script>
</body>
</html>
